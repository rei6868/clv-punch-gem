# File: .github/workflows/cron-jobs.yml
name: Vercel Cron Triggers (via GHA)

on:
  workflow_dispatch:
  schedule:
    # (Giờ UTC = Giờ VN - 7)

    # 1. Daily Reset (00:05 VN)
    - cron: '5 17 * * *' # 17:05 UTC

    # 2. WFH AM Reminders (T3, T4)
    - cron: '10 23 * * 1,2' # 23:10 UTC (T2, T3)
    - cron: '20 23 * * 1,2' # 23:20 UTC (T2, T3)
    - cron: '40 23 * * 1,2' # 23:40 UTC (T2, T3)
    - cron: '0 0 * * 2,3' # 00:00 UTC (T3, T4)
    - cron: '20 0 * * 2,3' # 00:20 UTC (T3, T4)
    - cron: '40 0 * * 2,3' # 00:40 UTC (T3, T4)
    - cron: '10 1 * * 2,3' # 01:10 UTC (T3, T4)
    - cron: '30 1 * * 2,3' # 01:30 UTC (T3, T4) - FINAL DEADLINE

    # 3. Office Day Reminder (07:45 VN)
    # (T2, T5, T6)
    - cron: '45 0 * * 1,4,5' # 00:45 UTC (T2, T5, T6)

    # 4. WFH PM Reminders (T3, T4)
    - cron: '5 11 * * 2,3' # 11:05 UTC (T3, T4)
    - cron: '20 11 * * 2,3' # 11:20 UTC (T3, T4)
    - cron: '40 11 * * 2,3' # 11:40 UTC (T3, T4)
    - cron: '0 12 * * 2,3' # 12:00 UTC (T3, T4)
    - cron: '0 13 * * 2,3' # 13:00 UTC (T3, T4) - FINAL DEADLINE

    # 5. OFF Day Reminder (18:00 VN - Chạy HÀNG NGÀY)
    - cron: '0 11 * * *' # 11:00 UTC

    # --- BẮT ĐẦU THÊM MỚI ---
    # 6. WFH Override PM Trigger (18:01 VN - Chạy HÀNG NGÀY)
    # (API sẽ tự kiểm tra xem có cờ override không)
    - cron: '1 11 * * *' # 11:01 UTC
    # --- KẾT THÚC THÊM MỚI ---

jobs:
  trigger-vercel-reset:
    name: Trigger Vercel Cron (Reset)
    # Chỉ chạy job này nếu lịch là '5 17 * * *'
    if: github.event.schedule == '5 17 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Ping /api/cron-reset
        run: |
          curl --request POST \
            --url 'https://auto-punch.vercel.app/api/cron-reset' \
            --header 'Authorization: Bearer ${{ secrets.PUNCH_SECRET }}' \
            --fail

  trigger-vercel-reminder:
    name: Trigger Vercel Cron (Reminder)
    # Chạy job này cho các lịch WFH/Office/OFF
    # --- SỬA LOGIC IF ---
    if: >
      github.event.schedule != '5 17 * * *' &&
      github.event.schedule != '1 11 * * *'
    # --- KẾT THÚC SỬA ---
    runs-on: ubuntu-latest
    steps:
      - name: Ping /api/cron-reminder
        run: |
          curl --request POST \
            --url 'https://auto-punch.vercel.app/api/cron-reminder' \
            --header 'Authorization: Bearer ${{ secrets.PUNCH_SECRET }}' \
            --fail

  # --- BẮT ĐẦU THÊM MỚI ---
  trigger-vercel-wfh-override:
    name: Trigger Vercel Cron (WFH Override PM)
    # Chỉ chạy job này nếu lịch là '1 11 * * *'
    if: github.event.schedule == '1 11 * * *'
    runs-on: ubuntu-latest
    steps:
      - name: Ping /api/cron-check-wfh
        run: |
          # (Chúng ta sẽ tạo API này ở bước tiếp theo)
          curl --request POST \
            --url 'https://auto-punch.vercel.app/api/cron-check-wfh' \
            --header 'Authorization: Bearer ${{ secrets.PUNCH_SECRET }}' \
            --fail
  # --- KẾT THÚC THÊM MỚI ---
