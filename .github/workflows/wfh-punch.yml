# File: .github/workflows/wfh-punch.yml
name: Cyberlogitec Auto Punch (WFH)

on:
  workflow_dispatch:
  schedule:
    # (Gi·ªù UTC = Gi·ªù VN - 7)
    # Ch·∫°y l√∫c 06:00 S√°ng VN (T3, T4)
    - cron: '0 23 * * 1,2' # 23:00 UTC (T2, T3)
    # Ch·∫°y l√∫c 18:00 Chi·ªÅu VN (T3, T4)
    - cron: '0 11 * * 2,3' # 11:00 UTC (T3, T4)

jobs:
  punch-in-out:
    name: Run Punch In/Out Script
    runs-on: ubuntu-latest
    # --- B·∫ÆT ƒê·∫¶U S·ª¨A ---
    timeout-minutes: 10 # <-- TƒÉng t·ª´ 5 l√™n 10
    # --- K·∫æT TH√öC S·ª¨A ---
    
    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      - name: 3. Set up Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 4. Install dependencies
        id: install_deps
        run: pnpm install # (ƒê·∫£m b·∫£o d√πng pnpm)

      - name: 5. Install Playwright browsers and dependencies
        id: install_playwright
        run: npx playwright install --with-deps chromium

      - name: 6. Run Playwright test
        id: run_playwright_test
        run: |
          npx playwright test tests/cyberlogitec.spec.js
        env:
          CYBERLOGITEC_USERNAME: ${{ secrets.CYBERLOGITEC_USERNAME }}
          CYBERLOGITEC_PASSWORD: ${{ secrets.CYBERLOGITEC_PASSWORD }}
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      
      - name: 7. Report Status to Vercel API
        if: always() # Lu√¥n ch·∫°y, k·ªÉ c·∫£ khi Step 6 fail
        run: |
          STATUS="fail"
          if [ "${{ steps.run_playwright_test.outcome }}" == "success" ]; then
            STATUS="success"
          fi
          
          # ƒê·ªçc outputs t·ª´ b∆∞·ªõc 6
          ERROR_MSG="${{ steps.run_playwright_test.outputs.error_message }}"
          IMAGE_URL="${{ steps.run_playwright_test.outputs.image_url }}"
          PUNCH_TIME="${{ steps.run_playwright_test.outputs.punch_time }}"

          # --- B·∫ÆT ƒê·∫¶U S·ª¨A (C·∫£i thi·ªán L·ªói) ---
          # (Fix l·ªói 'No details from GHA')
          if [ "$STATUS" == "fail" ] && [ -z "$ERROR_MSG" ]; then
            if [ "${{ job.status }}" == "cancelled" ] || [ "${{ steps.run_playwright_test.outcome }}" == "cancelled" ]; then
              ERROR_MSG="[GHA] Job was cancelled, possibly due to 10m timeout."
            else
              ERROR_MSG="[GHA] Playwright test failed but provided no error details."
            fi
          fi
          # --- K·∫æT TH√öC S·ª¨A ---

          PERIOD="am" 
          HOUR_UTC=$(date -u +'%H')
          if [ "$HOUR_UTC" -gt "10" ] && [ "$HOUR_UTC" -lt "22" ]; then
             PERIOD="pm"
          fi
          
          JSON_PAYLOAD=$(cat <<EOF
          {
            "status": "$STATUS",
            "period": "$PERIOD",
            "message": "${ERROR_MSG//\"/\\\"}",
            "imageUrl": "${IMAGE_URL//\"/\\\"}",
            "recordedPunchTime": "${PUNCH_TIME//\"/\\\"}"
          }
          EOF
          )
          
          echo "Sending payload: $JSON_PAYLOAD"

          curl -X POST 'https://auto-punch.vercel.app/api/state/report' \
            -H 'Authorization: Bearer ${{ secrets.PUNCH_SECRET }}' \
            -H 'Content-Type: application/json' \
            -d "$JSON_PAYLOAD" \
            --fail
            
      - name: 8. Notify on Workflow Setup Failure
        if: failure() && (steps.install_deps.outcome == 'failure' || steps.install_playwright.outcome == 'failure')
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}' \
          -d '{ "text": "üö® **Workflow `Auto Punch (WFH)` ƒë√£ th·∫•t b·∫°i.**\nL·ªói x·∫£y ra ·ªü b∆∞·ªõc setup (v√≠ d·ª•: install dependencies), kh√¥ng ph·∫£i l·ªói do script test.\nC·∫ßn ki·ªÉm tra ngay t·∫°i tab Actions c·ªßa GitHub." }'
