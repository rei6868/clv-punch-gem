# File: .github/workflows/wfh-punch.yml
name: Cyberlogitec Auto Punch (WFH)

on:
  workflow_dispatch:
  schedule:
    # (Gi·ªù UTC = Gi·ªù VN - 7)
    # Ch·∫°y l√∫c 06:00 S√°ng VN (T3, T4)
    - cron: '0 23 * * 1,2' # 23:00 UTC (T2, T3)
    # Ch·∫°y l√∫c 18:00 Chi·ªÅu VN (T3, T4)
    - cron: '0 11 * * 2,3' # 11:00 UTC (T3, T4)

jobs:
  punch-in-out:
    name: Run Punch In/Out Script
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    # Bi·∫øn ƒë·ªÉ truy·ªÅn k·∫øt qu·∫£ gi·ªØa c√°c b∆∞·ªõc
    outputs:
      punch_status: ${{ steps.run_playwright_test.outcome }}
      punch_time: ${{ steps.run_playwright_test.outputs.punch_time || '' }}
      error_message: ${{ steps.run_playwright_test.outputs.error_message || '' }}
      image_url: ${{ steps.run_playwright_test.outputs.image_url || '' }}

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      # (ƒê√£ x√≥a b∆∞·ªõc 2. Check Automation Status)

      - name: 3. Set up Node.js v20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: 4. Install dependencies
        id: install_deps
        run: npm install

      - name: 5. Install Playwright browsers and dependencies
        id: install_playwright
        run: npx playwright install --with-deps chromium

      - name: 6. Run Playwright test
        id: run_playwright_test
        run: |
          # Ch·∫°y test v√† cho ph√©p n√≥ th·∫•t b·∫°i m√† kh√¥ng d·ª´ng workflow
          npx playwright test tests/cyberlogitec.spec.js || true
          
          # (L∆∞u √Ω: Script playwright (cyberlogitec.spec.js) s·∫Ω c·∫ßn ƒë∆∞·ª£c s·ª≠a 
          # ƒë·ªÉ ghi k·∫øt qu·∫£ (imageUrl, errorMessage, punchTime) v√†o GITHUB_OUTPUT. 
          # T·∫°m th·ªùi ch√∫ng ta s·∫Ω report success/failure.)
          
        env:
          CYBERLOGITEC_USERNAME: ${{ secrets.CYBERLOGITEC_USERNAME }}
          CYBERLOGITEC_PASSWORD: ${{ secrets.CYBERLOGITEC_PASSWORD }}
          GOOGLE_CHAT_WEBHOOK_URL: ${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }} # V·∫´n c·∫ßn cho utils c≈©
          CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
          CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
          CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      
      - name: 7. Report Status to Vercel API
        # Lu√¥n ch·∫°y, k·ªÉ c·∫£ khi b∆∞·ªõc 6 th·∫•t b·∫°i
        if: always()
        run: |
          STATUS="fail"
          if [ "${{ steps.run_playwright_test.outcome }}" == "success" ]; then
            STATUS="success"
          fi
          
          # (Ch√∫ng ta s·∫Ω t·∫°m th·ªùi b·ªè qua message, imageUrl cho ƒë·∫øn khi s·ª≠a playwright)
          MESSAGE="GHA run result: ${{ steps.run_playwright_test.outcome }}"

          # L·∫•y period (am/pm) t·ª´ gi·ªù UTC c·ªßa GHA
          # (ƒê√¢y l√† c√°ch GHA t·ª± x√°c ƒë·ªãnh AM/PM)
          PERIOD="am" 
          HOUR_UTC=$(date -u +'%H')
          if [ "$HOUR_UTC" -gt "10" ] && [ "$HOUR_UTC" -lt "22" ]; then
             PERIOD="pm"
          fi
          
          # G·ª≠i JSON payload
          curl -X POST 'https://auto-punch.vercel.app/api/state/report' \
            -H 'Authorization: Bearer ${{ secrets.PUNCH_SECRET }}' \
            -H 'Content-Type: application/json' \
            -d '{
                  "status": "'"$STATUS"'",
                  "period": "'"$PERIOD"'",
                  "message": "'"$MESSAGE"'",
                  "imageUrl": ""
                }' \
            --fail
            
      - name: 8. Notify on Workflow Setup Failure
        # Ch·ªâ ch·∫°y n·∫øu C√ÄI ƒê·∫∂T (install) th·∫•t b·∫°i.
        if: failure() && (steps.install_deps.outcome == 'failure' || steps.install_playwright.outcome == 'failure')
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}' \
          -d '{ "text": "üö® **Workflow `Auto Punch (WFH)` ƒë√£ th·∫•t b·∫°i.**\nL·ªói x·∫£y ra ·ªü b∆∞·ªõc setup (v√≠ d·ª•: install dependencies), kh√¥ng ph·∫£i l·ªói do script test.\nC·∫ßn ki·ªÉm tra ngay t·∫°i tab Actions c·ªßa GitHub." }'

      # (ƒê√£ x√≥a b∆∞·ªõc Notify if Skipped)