# Agent, vui l√≤ng t·∫°o m·ªôt file m·ªõi t√™n l√†
# '.github/workflows/check-status.yml'.
#
# M·ª•c ti√™u: T·∫°o workflow n√†y ƒë·ªÉ ki·ªÉm tra 'config.json'
# l√∫c 8:00 AM (tr∆∞·ªõc gi·ªù punch-in) v√† g·ª≠i c·∫£nh b√°o
# n·∫øu h·ªá th·ªëng ƒëang b·ªã T·∫ÆT.
#
# Vui l√≤ng t·∫°o file v·ªõi n·ªôi dung sau:

name: Check Punch Status
on:
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng
  schedule:
    # Ch·∫°y l√∫c 1:00 UTC (8:00 S√°ng VN) - Th·ª© 3, Th·ª© 4
    # Ch·∫°y tr∆∞·ªõc 35 ph√∫t so v·ªõi workflow ch√≠nh
    - cron: '0 1 * * 2,3'

jobs:
  check-status-and-notify:
    name: Check Status and Notify
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: 1. Check out repository
        uses: actions/checkout@v4

      - name: 2. Check Automation Status
        id: check_config
        run: |
          # C√†i 'jq' ƒë·ªÉ ƒë·ªçc JSON
          sudo apt-get install -y jq
          # ƒê·ªçc gi√° tr·ªã t·ª´ config.json
          IS_ENABLED=$(jq '.isAutomationEnabled' config.json)
          echo "Automation enabled: $IS_ENABLED"
          # Set output
          echo "is_enabled=$IS_ENABLED" >> $GITHUB_OUTPUT

      - name: 3. Send Warning Notification if Disabled
        if: steps.check_config.outputs.is_enabled == 'false' # Ch·ªâ ch·∫°y n·∫øu b·ªã T·∫ÆT
        run: |
          curl -X POST -H 'Content-Type: application/json' \
          '${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}' \
          -d '{
                "cardsV2": [
                  {
                    "cardId": "reminder-card-disabled",
                    "card": {
                      "header": {
                        "title": "üö® C·∫¢NH B√ÅO: Auto-Punch ƒêang T·∫ÆT",
                        "subtitle": "Ph√°t hi·ªán l√∫c 8:00 AM",
                        "imageUrl": "https://i.imgur.com/A53t3zP.png",
                        "imageType": "CIRCLE"
                      },
                      "sections": [
                        {
                          "widgets": [
                            {
                              "textParagraph": {
                                "text": "H·ªá th·ªëng Auto-Punch (WFH) ƒëang ·ªü tr·∫°ng th√°i T·∫ÆT (Disabled).<br><br>B·∫°n s·∫Ω <b>b·ªã l·ª°</b> l∆∞·ª£t punch-in l√∫c 8:35 s√°ng nay.<br><br>Vui l√≤ng <b>b·∫≠t l·∫°i</b> h·ªá th·ªëng (thay ƒë·ªïi `config.json`) ho·∫∑c t·ª± punch-in th·ªß c√¥ng."
                              }
                            }
                          ]
                        }
                      ]
                    }
                  }
                ]
              }'